# utag

## 概要

MP3, FLACなどの音楽ファイルのタグとファイル名を一括編集するCLIツール。

## コンセプト

今日ではCDからのリッピングだけでなくダウンロード販売でもFLACなどの音源を入手できる。

販売サイトごとにタグとファイル名の付け方がバラバラなので、購入したままだと統一感がない。

そこで、所定のルールに沿うようにタグとファイル名を一括変更するツールとしてutagを開発した。

utagはUnified Tagの略。

## 対象とするファイル形式

- MP3
- FLAC
- M4A

## 使い方

### 前提

- utagコマンドとして実行できるようにPATHが設定されている。
- カレントディレクトリに処理対象の音楽ファイルが配置されている。

### エクスポート

タグを設定するには、設定するタグをtagsファイルに書く。

これを1から手書きする手間を省くために、今設定されているタグからtagsファイルを出力するエクスポート機能がある。

`$ utag e`

でエクスポートを実行する。

アートワークが設定されていれば、それもFolder.jpg / Folder.pngなどの名前で出力する。

### インポート

tagsファイルと（設定するなら）アートワークのFolder.jpgまたはFolder.pngを同じディレクトリに配置する。

tagsファイルの書き方は後述する。

`$ utag i`

でタグとアートワークを設定するインポートを実行する。

### リネーム

ファイル名を変更するリネームは以下のように実行する。

`$ utag r`

リネームすると以下の書式でファイル名を変更する。

{トラック番号}.{タイトル}.{拡張子}

タイトルにファイル名に使えない文字が含まれている場合は空白に置き換えたり削除したりする。

この仕様の詳細は割愛する。

ディスク枚数が2つ以上だと、ファイル名の先頭に

{ディスク番号}.

も付与する。

### オプションなし実行

`$ utag`

とオプションなしで実行すると、
tagsファイルがなければエクスポート、
あればインポートとリネームの実行になる。

## tagsファイルの仕様

UTF-8（BOMなし）かつ改行コードLFのテキストファイル。

例）

```
歌物語 -<物語>シリーズ主題歌集-
物語シリーズ
2016-01-06

staple stable//斎藤千和
帰り道//加藤英美里
ambivalent world//沢城みゆき
恋愛サーキュレーション//花澤香菜
sugar sweet nightmare//堀江由衣
君の知らない物語//supercell
二言目//斎藤千和
marshmallow justice//喜多村英梨
白金ディスコ//井口裕香
ナイショの話//ClariS
perfect slumbers//堀江由衣
消えるdaydream//河野マリナ

chocolate insomnia//堀江由衣
happy bite//加藤英美里
アイヲウタエ//春奈るな
the last day of my adolescence//沢城みゆき
花痕 -shirushi-//河野マリナ
もうそう♡えくすぷれす//花澤香菜
white lies
その声を覚えてる//河野マリナ
fast love//斎藤千和
木枯らしセンティメント//斎藤千和//三木眞一郎
snowdrop//春奈るな//河野マリナ
```

1行目はアルバム名。

2行目はアルバムアーティスト名。  
アルバムアーティスト名を書くとアーティスト名のタグにも設定される。

3行目は発売日。  
yyyy-mm-dd形式が基本だがそのまま設定するだけなので違ってもエラーにはならない。

4行目は空白行。  
1～3行目は未設定でよければ空白行にしてもよいが、4行目が空白行で5行目からトラック情報である形は崩さないこと。

5行目からはトラック情報で、基本的にはタイトルのみ。  
曲ごとのアーティスト名を設定したければ//で区切ってタイトルの後に書く。  
複数のアーティストを設定できる。

ディスクが複数枚のアルバムならディスク番号が切り替わるところで空白行を入れる。

## ファイル形式ごとの設定されるタグの詳細

### MP3 & WAV

エクスポートではID3v1およびID3v2で設定されたタグを読み込む。

インポートではID3v2.4で設定する。  
既存のID3v2はすべて削除する。  

- TALB: アルバム名
- TPE2: アルバムアーティスト名
- TDRL: 発売日
- TPOS: ディスク番号/総ディスク数
- TRCK: トラック番号/総トラック数
- TIT2: タイトル
- TPE1: アーティスト名(\00区切りで1つのタグに設定)
- APIC: アートワークをフロントカバーとして設定

### FLAC

インポートでは既存のタグと画像はすべて削除する。  

- ALBUM: アルバム名
- ALBUMARTIST: アルバムアーティスト名
- DATE: 発売日
- DISCNUMBER: ディスク番号
- DISCTOTAL: 総ディスク数
- TRACKNUMBER: トラック番号
- TRACKTOTAL: 総トラック数
- TITLE: タイトル
- ARTIST: アーティスト名（件数分）

### M4A

インポートでは既存のタグと画像はすべて削除する。

- ©alb: アルバム名
- aART: アルバムアーティスト名
- ©day: 発売日
- disk: ディスク番号 総ディスク数
- trkn: トラック番号 総トラック数
- ©nam: タイトル
- ©ART: アーティスト名（件数分）
- covr: アートワークを設定

## インストール

パッケージマネージャーを使わないならGitHubのReleasesからutag-vX.X.X.zipを  
ダウンロード、展開して動作環境にあったバイナリを利用する。

- macOS Intel: utag-darwin-amd64-vX.X.X
- macOS ARM(M1など): utag-darwin-arm64-vX.X.X
- Linux 32bit: utag-linux-386-vX.X.X
- Linux 64bit: utag-linux-amd64-vX.X.X
- Windows 32bit: utag-windows-386-vX.X.X.exe
- Windows 64bit: utag-windows-amd64-vX.X.X.exe

## 開発

### 利用した製品、サービス、開発環境など

Pythonで作る方が簡単だが、実行にインタプリタを必要とする言語で開発するとユーザーのインストール作業が煩雑になる。  
そのためネイティブコンパイル可能な言語からRustを採用した。

Goでも実装したがm4aのライブラリに要求に合うものがなかった。

### 今後の予定

DSFに対応したい。

エクスポートだけは実装しているが使用しているcrateに書き込み機能がないのでインポートできない。
